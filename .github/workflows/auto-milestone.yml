name: Auto-assign milestone from due date

on:
  issues:
    types: [opened, edited]

jobs:
  assign-milestone:
    runs-on: ubuntu-latest
    permissions:
      issues: write # create / update milestone & issue
    steps:
      - uses: actions/github-script@v7
        with:
          script: |
            const {owner, repo} = context.repo;
            const body = context.payload.issue.body ?? '';
            // "ë§ˆê°ì¼" ì…ë ¥ë€ ë°”ë¡œ ì•„ë˜ì˜ YYYY-MM-DD ì¶”ì¶œ
            const match = body.match(/ë§ˆê°ì¼.*\r?\n\r?\n(\d{4}-\d{2}-\d{2})/);
            if (!match) { return console.log('â­ï¸  No due date'); }

            const due = match[1];                 // 2025-07-31
            const title = `Sprint ${due}`;        // Sprint 2025-07-31

            // 1ï¸âƒ£  ì´ë¯¸ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
            const {data: openMs} = await github.rest.issues.listMilestones({
              owner, repo, state: 'open'
            });
            let milestone = openMs.find(m => m.title === title);

            // 2ï¸âƒ£  ì—†ìœ¼ë©´ ìƒì„±
            if (!milestone) {
              const res = await github.rest.issues.createMilestone({
                owner, repo,
                title,
                due_on: `${due}T23:59:59Z`
              });
              milestone = res.data;
              console.log(`ğŸ†• Created milestone #${milestone.number}`);
            }

            // 3ï¸âƒ£  ì´ìŠˆì— ì—°ê²°
            await github.rest.issues.update({
              owner, repo,
              issue_number: context.issue.number,
              milestone: milestone.number
            });
            console.log(`ğŸ”— Issue â†’ Milestone #${milestone.number}`);
