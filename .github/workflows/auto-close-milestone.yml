# .github/workflows/auto-close-milestone.yml
name: Auto-close empty milestones

on:
  pull_request:
    types: [closed] # ë³‘í•© ì™„ë£Œ PR
  issues:
    types: [closed] # ìˆ˜ë™ìœ¼ë¡œ ë‹«íŒ ì´ìŠˆ
  schedule:
    - cron: '0 3 * * *' # ë§¤ì¼ 03:00 UTC ì ê²€

jobs:
  close-empty:
    # PR ì´ë²¤íŠ¸ì¼ ë•ŒëŠ” merged == true ì¸ ê²½ìš°ë§Œ ì‹¤í–‰
    if: github.event_name != 'pull_request' || github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    permissions:
      issues: write # milestone Â· issue ìˆ˜ì •
    steps:
      - uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;

            /**
             * PR/Issue/Schedule â†’ ì ê²€ ëŒ€ìƒ ë§ˆì¼ìŠ¤í†¤ ë°°ì—´ ë§Œë“¤ê¸°
             */
            let targets = [];
            if (context.eventName === 'schedule') {
              // ëª¨ë“  ì—´ë ¤ ìˆëŠ” ë§ˆì¼ìŠ¤í†¤
              const { data } = await github.rest.issues.listMilestones({ owner, repo, state: 'open' });
              targets = data;
            } else {
              const src = context.payload.issue ?? context.payload.pull_request;
              if (src && src.milestone) {
                targets = [src.milestone];
              }
            }
            if (targets.length === 0) {
              return console.log('â­ï¸  No milestone to check');
            }

            /**
             * ë§ˆì¼ìŠ¤í†¤ë§ˆë‹¤ ì—´ë¦° ì´ìŠˆ/PR ë‚¨ì•„ìˆëŠ”ì§€ í™•ì¸ â†’ ì—†ìœ¼ë©´ state: closed
             */
            for (const ms of targets) {
              const { data: openItems } = await github.rest.issues.listForRepo({
                owner,
                repo,
                state: 'open',
                milestone: ms.number,
                per_page: 1            // 1ê°œë§Œ ì°¾ì•„ë„ ì—´ë ¤ìˆìŒì´ í™•ì¸ë¨
              });

              if (openItems.length === 0) {
                await github.rest.issues.updateMilestone({
                  owner,
                  repo,
                  milestone_number: ms.number,
                  state: 'closed'
                });
                console.log(`âœ… Closed milestone #${ms.number} (${ms.title})`);
              } else {
                console.log(`ğŸŸ¡ Milestone #${ms.number} still has open items`);
              }
            }
